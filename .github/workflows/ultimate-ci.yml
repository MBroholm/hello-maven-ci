name: Ultimate CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:

  # ---------------------------------------------------------
  # 1. Pull Request Checks
  # ---------------------------------------------------------
  pr-check:
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/common-java.yml
    with:
      run_checkstyle: false
      run_coverage: false
      run_docker: false

  # ---------------------------------------------------------
  # 2. CI Build + Deploy
  # ---------------------------------------------------------
  build:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/')
    uses: ./.github/workflows/common-java.yml
    with:
      run_checkstyle: true
      run_coverage: true
      run_docker: true
      environment: ${{ github.ref_name == 'main' && 'production' || 'staging' }}

  # ---------------------------------------------------------
  # 3. Release Workflow (Triggered by tags)
  # ---------------------------------------------------------
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/common-java.yml
    with:
      run_checkstyle: false
      run_coverage: false
      run_docker: true
      environment: production

  create_release:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## Docker Image
            ```
            docker pull ghcr.io/${{ needs.release.outputs.owner }}/hello-maven:${{ github.ref_name }}
            ```

  # ---------------------------------------------------------
  # 4. Nightly Build
  # ---------------------------------------------------------
  nightly:
    if: github.event_name == 'schedule'
    uses: ./.github/workflows/common-java.yml
    with:
      run_checkstyle: false
      run_coverage: false
      run_docker: false